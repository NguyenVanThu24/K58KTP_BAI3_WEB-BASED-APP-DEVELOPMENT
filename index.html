<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nguyễn Văn Thứ – IoT Monitor</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#3b82f6;
      --ok:#10b981;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, Roboto, "Helvetica Neue", Arial;
    }
    * {
      box-sizing: border-box;
    }
    html,body{
      height:100%;
      margin:0;
      background:linear-gradient(180deg,#071026, #07182a 60%);
      color:#e6eef8;
      overflow-x: hidden;
    }
    .app{
      max-width:1140px;
      margin:0 auto;
      padding:32px 24px;
      animation: fadeIn 0.6s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    header{
      display:flex;
      align-items:center;
      gap:16px;
      padding-bottom:24px;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .title{
      font-size:24px;
      font-weight:700;
      letter-spacing:-0.02em;
      background: linear-gradient(135deg, #e6eef8 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle{
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }
    .card{
      background:var(--card);
      padding:24px;
      border-radius:16px;
      box-shadow: 0 8px 32px rgba(2,6,23,0.5);
      margin-top:24px;
      border:1px solid rgba(255,255,255,0.04);
      transition: all 0.3s ease;
    }
    .card:hover {
      border-color: rgba(255,255,255,0.08);
      box-shadow: 0 12px 40px rgba(2,6,23,0.6);
    }
    .row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .spacer{flex:1}
    .btn{
      background:var(--accent);
      border:none;
      color:white;
      padding:10px 18px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    .btn:hover{
      background:#2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn:active{
      transform: translateY(0);
    }
    .btn.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow: none;
    }
    .btn.ghost:hover{
      background:rgba(255,255,255,0.05);
      border-color:rgba(255,255,255,0.2);
    }
    .login-form{
      max-width:460px;
      margin:24px auto;
    }
    label{
      display:block;
      font-size:14px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:8px;
    }
    input[type="text"], input[type="password"]{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      color:inherit;
      font-size:14px;
      transition: all 0.2s ease;
    }
    input[type="text"]:focus, input[type="password"]:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(255,255,255,0.05);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .sensor-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:16px;
      margin-top:20px;
    }
    .sensor{
      padding:20px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      display:flex;
      flex-direction:column;
      gap:12px;
      border:1px solid rgba(255,255,255,0.05);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .sensor::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), #06b6d4);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .sensor:hover::before {
      opacity: 1;
    }
    .sensor:hover{
      transform: translateY(-4px);
      border-color:rgba(255,255,255,0.12);
      box-shadow: 0 12px 32px rgba(2,6,23,0.4);
    }
    .sensor .name{
      font-weight:700;
      font-size:16px;
      color:#e6eef8;
    }
    .sensor .value{
      font-size:32px;
      font-weight:700;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }
    .small{
      font-size:13px;
      color:var(--muted);
    }
    .footer{
      margin-top:24px;
      padding-top:20px;
      border-top:1px solid rgba(255,255,255,0.05);
      color:var(--muted);
      font-size:13px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    /* modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,0.85);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      animation: fadeIn 0.2s ease;
    }
    .modal{
      width:90%;
      max-width:1200px;
      height:85vh;
      background:#0b1220;
      border-radius:16px;
      padding:20px;
      display:flex;
      flex-direction:column;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 60px rgba(2,6,23,0.8);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(40px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal header{
      display:flex;
      align-items:center;
      gap:12px;
      padding-bottom:16px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .modal iframe{
      flex:1;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.05);
      margin-top:16px;
      background: #000;
    }
    .badge{
      padding:6px 12px;
      border-radius:999px;
      background:rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      font-size:12px;
      font-weight:600;
      border:1px solid rgba(59, 130, 246, 0.3);
    }
    .error{color:var(--danger)}
    .success{color:var(--ok)}
    .note{
      font-size:13px;
      color:var(--muted);
      margin-top:12px;
      padding:12px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      border-left:3px solid rgba(59, 130, 246, 0.5);
    }
    .logo{
      width:56px;
      height:56px;
      border-radius:14px;
      background:linear-gradient(135deg,#2563eb,#06b6d4);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:20px;
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
      letter-spacing: -0.02em;
    }
    .user-welcome {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .user-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 28px;
    }
    .login-header h2 {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }
    .login-header p {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }
    .dashboard-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 4px;
    }
    .dashboard-title {
      font-weight: 700;
      font-size: 20px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    @media (max-width: 768px) {
      .app {
        padding: 20px 16px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .title {
        font-size: 20px;
      }
      .sensor-grid {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        width: 100%;
      }
      .btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">NT</div>
      <div class="brand">
        <div class="title">Nguyễn Văn Thứ – IoT Monitor</div>
        <div class="subtitle">Single Page Application · Frontend demo cho đồ tài Lập trình web trên Linux</div>
      </div>
      <div class="spacer"></div>
      <div id="user-area"></div>
    </header>

    <div id="content">

      <div id="loginCard" class="card login-form">
        <div class="login-header">
          <h2>Đăng nhập</h2>
          <p>Dùng tài khoản đã tạo trong MariaDB</p>
        </div>
        
        <div class="form-group">
          <label>Username</label>
          <input id="username" type="text" placeholder="admin" />
        </div>
        
        <div class="form-group">
          <label>Mật khẩu</label>
          <input id="password" type="password" placeholder="••••••" />
        </div>
        
        <div style="display:flex;gap:10px;margin-top:8px">
          <button id="btnLogin" class="btn" style="flex:1">Đăng nhập</button>
          <button id="btnClear" class="btn ghost">Xóa</button>
        </div>
        
        <div id="loginStatus" class="small" style="margin-top:12px;text-align:center"></div>
        
        <div class="note">
          <strong>Ghi chú:</strong> mật khẩu được <strong>hash SHA-256</strong> trên trình duyệt trước khi gửi.
        </div>
      </div>

      <div id="mainCard" class="card" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px">
          <div class="dashboard-header">
            <div class="dashboard-title">Bảng điều khiển cảm biến</div>
            <div class="small">Hiển thị giá trị mới nhất của các thông số IOT</div>
          </div>
          <div class="action-buttons">
            <button id="btnRefresh" class="btn ghost">Làm mới</button>
            <button id="btnLogout" class="btn">Đăng xuất</button>
          </div>
        </div>

        <div id="sensors" class="sensor-grid">
          <!-- sensor cards injected here -->
        </div>

        <div class="footer">
          <span class="badge">Demo</span>
          <span>Node-RED backend: <code class="small">POST /api/login</code>, <code>/api/latest</code> (GET)</span>
        </div>
      </div>

    </div>
  </div>

  <!-- modal for grafana -->
  <div id="modal" class="modal-backdrop">
    <div class="modal">
      <header>
        <strong id="modalSensor" style="font-size:18px">Sensor</strong>
        <div style="flex:1"></div>
        <button id="modalClose" class="btn ghost">Đóng</button>
      </header>
      <iframe id="grafanaFrame" src=""></iframe>
    </div>
  </div>

<script>
/*
  HƯỚNG DẪN TÍCH HỢP BACKEND (Node-RED)
  - POST /api/login
      body: { username: "...", password_hash: "..." }
      returns: { ok: true, token: "..." }  // token được set trong cookie iot_token (frontend cũng lưu)
  - GET /api/latest
      headers: Authorization: Bearer <token>  (frontend sẽ gửi cookie credentials include)
      returns: { ok: true, data: [ { sensor_name, value, timestamp }, ... ] }
  - Grafana: thay giá trị grafanaBaseUrl bên dưới thành đường dẫn Grafana bạn muốn dùng,
    hoặc để path share dashboard/panel phù hợp.
*/

const cfg = {
  apiBase: '',               // ví dụ: '' để gọi cùng host (nếu Nginx reverse proxy)
  loginEndpoint: '/api/login',
  latestEndpoint: '/api/latest',
  grafanaBaseUrl: '/grafana', // đổi nếu cần; iframe sẽ dùng grafanaBaseUrl + '/d/...'
  grafanaPanelTemplate: ''    // nếu bạn có link panel cụ thể, để ở đây, ví dụ '/d/abcd/your-dashboard?orgId=1&panelId=2'
};

// helpers
async function sha256hex(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

function setCookie(name, value, days=7){
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${value}; path=/; SameSite=Lax; expires=${d.toUTCString()}`;
}
function getCookie(name){
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
function eraseCookie(name){ setCookie(name,'', -1); }

function showLogin(show){
  document.getElementById('loginCard').style.display = show ? '' : 'none';
  document.getElementById('mainCard').style.display = show ? 'none' : '';
}

function showStatus(msg, ok=true){
  const el = document.getElementById('loginStatus');
  el.textContent = msg;
  el.style.color = ok ? 'var(--ok)' : 'var(--danger)';
  if(!msg) el.style.display = 'none'; else el.style.display = '';
}

/* UI actions */
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  if(!username || !password){ showStatus('Nhập username & password', false); return; }
  showStatus('Đang đăng nhập...', true);

  try{
    const passhash = await sha256hex(password);
    const res = await fetch(cfg.apiBase + cfg.loginEndpoint, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      credentials: 'include', // gửi cookie nếu cùng domain
      body: JSON.stringify({ username, password_hash: passhash })
    });
    const j = await res.json();
    if(!j.ok){ showStatus(j.error || 'Đăng nhập thất bại', false); return; }
    // lưu token vào cookie
    if(j.token) setCookie('iot_token', j.token, 7);
    localStorage.setItem('iot_user', username);
    showStatus('Đăng nhập thành công', true);
    await loadSensors();
    showLogin(false);
  }catch(e){
    console.error(e);
    showStatus('Lỗi kết nối', false);
  }
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('username').value='';
  document.getElementById('password').value='';
  showStatus('');
});
document.getElementById('btnLogout').addEventListener('click', ()=>{
  eraseCookie('iot_token');
  localStorage.removeItem('iot_user');
  showLogin(true);
});
document.getElementById('btnRefresh').addEventListener('click', loadSensors);

/* modal */
document.getElementById('modalClose').addEventListener('click', ()=>{
  document.getElementById('modal').style.display = 'none';
  document.getElementById('grafanaFrame').src = '';
});

/* main logic */
async function loadSensors(){
  const token = getCookie('iot_token');
  if(!token){ showLogin(true); return; }
  showStatus('');
  try{
    const res = await fetch(cfg.apiBase + cfg.latestEndpoint, {
      headers: { 'Authorization': 'Bearer ' + token },
      credentials: 'include'
    });
    const j = await res.json();
    if(!j.ok){ showStatus(j.error || 'Không lấy được dữ liệu', false); return; }
    renderSensors(j.data || []);
    showLogin(false);
    showUserArea();
  }catch(e){
    console.error(e);
    showStatus('Lỗi khi lấy dữ liệu', false);
  }
}

function renderSensors(list){
  const wrap = document.getElementById('sensors');
  wrap.innerHTML = '';
  if(!list.length){
    wrap.innerHTML = '<div class="small" style="text-align:center;padding:40px 0;color:var(--muted)">Chưa có dữ liệu cảm biến.</div>';
    return;
  }
  list.forEach(item=>{
    const el = document.createElement('div');
    el.className = 'sensor';
    el.innerHTML = `
      <div class="row">
        <div class="name">${escapeHtml(item.sensor_name)}</div>
        <div class="spacer"></div>
        <div class="badge">${formatTime(item.timestamp)}</div>
      </div>
      <div class="value">${Number(item.value).toFixed(2)} <span class="small" style="font-size:14px;font-weight:400">units</span></div>
      <div class="small">Latest: ${formatTime(item.timestamp)}</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn open" data-sensor="${escapeHtml(item.sensor_name)}" style="flex:1">Xem biểu đồ</button>
        <button class="btn ghost" onclick="alert('Chi tiết tạm thời chưa có')">Chi tiết</button>
      </div>
    `;
    wrap.appendChild(el);
  });
  // add listeners
  wrap.querySelectorAll('.open').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const sensor = e.currentTarget.dataset.sensor;
      openGrafana(sensor);
    });
  });
}

function openGrafana(sensor){
  // Default grafana panel URL template. Replace grafanaBaseUrl/grafanaPanelTemplate with your real grafana panel link.
  let url = cfg.grafanaBaseUrl;
  if(cfg.grafanaPanelTemplate && cfg.grafanaPanelTemplate.length){
    url = cfg.grafanaBaseUrl + cfg.grafanaPanelTemplate + `&var-sensor=${encodeURIComponent(sensor)}`;
  } else {
    // fallback: open grafana home
    url = cfg.grafanaBaseUrl + '/';
  }
  document.getElementById('modalSensor').textContent = sensor + ' – Biểu đồ';
  document.getElementById('grafanaFrame').src = url;
  document.getElementById('modal').style.display = 'flex';
}

/* small utils */
function formatTime(t){
  if(!t) return '';
  const d = new Date(t);
  return d.toLocaleString('vi-VN', { 
    day: '2-digit', 
    month: '2-digit', 
    hour: '2-digit', 
    minute: '2-digit' 
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function showUserArea(){
  const ua = document.getElementById('user-area');
  const user = localStorage.getItem('iot_user') || 'Guest';
  const initial = user.charAt(0).toUpperCase();
  ua.innerHTML = `
    <div class="user-welcome">
      <div class="user-icon">${escapeHtml(initial)}</div>
      <div style="display:flex;flex-direction:column">
        <div class="small" style="font-size:12px">Xin chào,</div>
        <div style="font-weight:600;font-size:14px">${escapeHtml(user)}</div>
      </div>
    </div>
  `;
}

/* init */
(function init(){
  // If token exists, auto load
  if(getCookie('iot_token')) {
    showLogin(false);
    loadSensors();
  } else {
    showLogin(true);
  }
})();
</script>
</body>
</html>